name: Append Destination Branch to PR Title

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write

jobs:
  update-pr-title:
    runs-on: ubuntu-latest
    name: Update PR Title with Destination Branch
    steps:
      - name: Update PR title
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          NEW_TITLE="${PR_TITLE} -> \`${BASE_BRANCH}\`"
          if [[ "$PR_TITLE" != *"-> \`${BASE_BRANCH}\`"* ]]; then
            PAYLOAD=$(jq -n --arg title "$NEW_TITLE" '{title: $title}')
            curl -s -X PATCH \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER" \
              -d "$PAYLOAD"
          fi
